/*
    Uppgift 4.2 - Webblagring (Local Storage)
    av Ida Svensson  

    Jag har läst på flera ställen om att jQuery Mobile inte skulle vara optimalt för 
    PhoneGap-appar sedan det från början är utvecklat för mobila webbsidor och blir
    därför ett tungt ramverk för en app vilket kan sänka prestandan rejält, så därför
    valde jag att testa att jobba enbart med PhoneGap från scratch. Det har krävt 
    en del enklare fixar och egen mindre robust funktion för 'changePage' bl.a., men
    var en skön utmaning att testa sig på. Det fyller sin funktion nu, men skulle behöva
    mycket mer puts i en riktig app. Just nu skulle det bara stödja programmeringen,
    som ju är kursens fokus.

    Har blandat lite svenska och engelska i kommentarerna, sorry för det. Tanken var nog
    att skriva på svenska för uppgiftens skull, men faller in i gamla vanor och kommenterar
    alltid på engelska så, ja. Ni får ha överseende där. Mycket säger sig självt eller är 
    mer noggrannt beskrivet i uppgifter där jag använt funktionerna, så har kommenterat där
    det kändes som att det behövdes.

    Tack för den här kursen!
*//*globals $, jQuery, Handlebars, google*//* For JSLint */$(function(){var e={init:function(){this.bindEvents();this.noteListView=null;this.noteList=null;this.singlePage=null;this.noteForm=null;this.db=null},bindEvents:function(){$(document).on("deviceready",this.onDeviceReady)},onDeviceReady:function(){e.db=window.sqlitePlugin.openDatabase("notes");e.noteListView=$("#note-listview");e.noteList=$("#note-list");e.singlePage=$("#single-note-page");e.noteForm=$("#note-form");e.testIfDatabaseExists();e.noteList.on("touchend","li",e.openEntry);$("#add").on("touchend",e.prepNewNote);$("#edit").on("touchend",e.editEntry);e.noteForm.on("touchend","#delete",e.deleteEntry);$(".attached-media").on("touchend","a",e.undisplayMedia);$("#capture-photo").on("touchend",e.capturePhoto);$("#get-photo").on("touchend",e.getPhoto);$("#record-sound").on("touchend",e.captureAudio);$("#capture-video").on("touchend",e.captureVideo);$("#save-note").on("touchend",e.writeEntry);$(document).on("backbutton",e.onBackButton)},changePage:function(e){var t=["home-page","add-note-page","single-note-page"],n=$.inArray(e,t);console.log("Page target: "+e+" at index "+n);$.each(t,function(t,n){if(n===e)return;console.log("Attempting to remove hidden class on page "+n);$("#"+n).addClass("ui-hidden")});$("#"+e).removeClass("ui-hidden")},onBackButton:function(t){t.preventDefault();e.changePage("home-page");console.log("Triggered back button.")},prepNewNote:function(t){console.log("Prepping note");e.changePage("add-note-page");if(t[0]!==undefined){e.noteForm.attr("data-id",t);console.log("Added data-id: "+t[0]+" to "+e.noteForm.attr("data-id"));e.db.transaction(e.readNoteData,e.onTxError,e.onTxSuccess);var n=$('<input type="button" id="delete" value="Delete"></input>');e.noteForm.append(n)}else{$("#add-note-page").find(".attached-media").remove();navigator.geolocation.getCurrentPosition(e.onGeoSuccess,e.onError)}},readNoteData:function(t){var n=e.noteForm.attr("data-id"),r='SELECT * FROM Notes WHERE id LIKE "'+n+'"';t.executeSql(r,[],e.populateFormData,e.onSqlError)},populateFormData:function(t,n){var r=n.rows.item(0).title,i=n.rows.item(0).text,s=n.rows.item(0).photopath,o=n.rows.item(0).videopath,u=n.rows.item(0).audiopath,a=$("#add-note-page");$("#add-note-page").find(".ui-page-title").text(r);console.log("Successfully got note data. Time to populate form.");r&&$("#new-note-title").val(r);i&&$("#new-note-text").val(i);s&&e.displayMedia(a,"photo",s);o&&e.displayMedia(a,"video",o);u&&e.displayMedia(a,"audio",u)},onGeoSuccess:function(t){console.log("Attempting to find geolocation.");var n=t.coords.latitude,r=t.coords.longitude,i=new google.maps.Geocoder,s=new google.maps.LatLng(n,r);console.log("Location LatLng: "+s);i.geocode({latLng:s},e.useGeoLocation)},useGeoLocation:function(e,t){console.log("Got geolocation. Time to use it.");var n;t===google.maps.GeocoderStatus.OK?e[1]&&(n=e[1].formatted_address):n="Location not found.";$("#add-note-page").find(".note-location").text(n)},testIfDatabaseExists:function(){var t=window.localStorage.getItem("dbExists");t===null?e.createDatabase():e.readDatabase()},createDatabase:function(){e.db.transaction(e.setupDB,e.onTxError,e.onSetupSuccess)},setupDB:function(e){e.executeSql("DROP TABLE IF EXISTS Notes");e.executeSql("CREATE TABLE IF NOT EXISTS Notes (id INTEGER PRIMARY KEY AUTOINCREMENT, title VARCHAR, text TEXT, date DATE, location VARCHAR, photopath VARCHAR, audiopath VARCHAR, videopath VARCHAR)")},onSetupSuccess:function(){window.localStorage.setItem("dbExists",1);console.log("Database successfully created.")},readDatabase:function(){console.log("Database exists. Time to read the data.");e.db.transaction(e.readAllData,e.onTxError,e.onTxSuccess)},readAllData:function(t){t.executeSql("SELECT * FROM Notes",[],e.renderNoteList,e.onSqlError)},onTxSuccess:function(){console.log("TX Success.")},onTxError:function(e){var t;e?t="TX Error: "+e.message+" ("+e.code+")":t="Unknown error.";console.log(t);navigator.notification.alert(t,null,"Error")},renderNoteList:function(t,n){if(n.rows){var r=n.rows.length;if(r>0){for(var i=0;i<r;i++){var s=$("<li></li>"),o=n.rows.item(i).id,u=n.rows.item(i).title,a=n.rows.item(i).text,f=n.rows.item(i).photopath,l=n.rows.item(i).videopath,c=n.rows.item(i).audiopath,h=n.rows.item(i).created,p;!a||a===undefined?p="":a.length>60?p=a.substring(0,60)+"...":p=a;console.log("Photo: "+f+", Excerpt: "+p);var d='<div class="note-content"><h2 class="note-title">'+u+"</h2>"+'<p class="note-excerpt">'+p+"</p>"+"</div>";s.html(d);s.addClass("note-item");s.attr("data-id",o);var v=$("<div></div>");v.addClass("note-thumb");s.prepend(v);f?v.css("background-image","url("+f+")"):l?v.css("background-image","url(img/video-default.png)"):c?v.css("background-image","url(img/audio-default.png)"):v.css("background-image","url(img/thumb-default.png)");e.noteList.append(s)}$("#new-note-title").val("");$("#new-note-text").val("")}else console.log("No records processed.")}else e.noteListView.html("There are no notes. Create one by tapping the +-sign.")},onSqlError:function(e){var t;e?t="SQL Error: "+e.message+" ("+e.code+")":t="Unknown error.";console.log(t);alert(t)},writeEntry:function(t){e.db.transaction(e.newEntry,e.onTxError,e.onTxSuccess)},newEntry:function(t){var n,r=$("#new-note-title").val(),i=$("#new-note-text").val(),s=new Date,o=s.getFullYear(),u=s.getMonth(),a=s.getDate(),f=s.getHours(),l=s.getMinutes()<10?"0":""+s.getMinutes(),c=o+"/"+u+"/"+a+" "+f+":"+l,h=$("#add-note-page").find(".note-location").text(),p,d;$("#add-note-page .attached-media img").get(0)?(p="photopath",d=$(".attached-media img").attr("src")):$("#add-note-page .attached-media video").get(0)?(p="videopath",d=$(".attached-media video").attr("src")):$("#add-note-page .attached-media audio").get(0)&&(p="audiopath",d=$(".attached-media audio").attr("src"));var v=e.noteForm.attr("data-id");if(!v)if(!p||!d){n="INSERT INTO Notes (title, text, date, location) VALUES (?, ?, ?, ?)";console.log("Attempting to add note entry: Title: "+r);t.executeSql(n,[r,i,c,h],e.onAddSuccess,e.onSqlError)}else{var n="INSERT INTO Notes (title, text, date, location, "+p+") VALUES (?, ?, ?, ?, ?)";console.log("Attempting to add media entry: Media name: "+p+", Media path: "+d);t.executeSql(n,[r,i,c,h,d],e.onAddSuccess,e.onSqlError)}else if(!p||!d){var n="UPDATE Notes SET title=?, text=?, date =? WHERE id=?";console.log("Attempting to update note entry: Title: "+r);t.executeSql(n,[r,i,c,v],e.onUpdateSuccess,e.onSqlError)}else{var n="UPDATE Notes SET title=?, text=?, date =?, "+p+"=? WHERE id=?";console.log("Attempting to update media entry: Media name: "+p+", Media path: "+d);t.executeSql(n,[r,i,c,d,v],e.onUpdateSuccess,e.onSqlError)}},onAddSuccess:function(t,n){console.log("Note successfully added.");alert("Anteckning sparad!");e.changePage("home-page");$("add-note-page").find(".attached-media").empty()},editEntry:function(t){var n=$("#single-note-page").attr("data-id");console.log("Opening note "+n+" for editing.");$("#add-note-page").find(".attached-media").remove();e.prepNewNote(n)},updateEntry:function(t){var n=$("textarea").val(),r=(new Date).getTime().toString(),i=e.noteForm.attr("data-id");console.log("Trying to update "+i+", "+n);var s="UPDATE Notes SET text=?, date =? WHERE id=?";t.executeSql(s,[n,r,i],e.onUpdateSuccess,e.onSqlError)},onUpdateSuccess:function(t,n){alert("Anteckning uppdaterad!");e.changePage("home-page");$("add-note-page").find(".attached-media").empty()},openEntry:function(t){var n=$(this).attr("data-id");console.log("Opening note "+n);$("#single-note-page").find(".attached-media").remove();e.changePage("single-note-page");$("#single-note-page").attr("data-id",n);e.db.transaction(e.showEntry,e.onTxError,e.onTxSuccess)},showEntry:function(t){var n=$("#single-note-page").attr("data-id");if(n){console.log("Found id: "+n);var r='SELECT * FROM Notes WHERE id LIKE "'+n+'"';t.executeSql(r,[],e.onShowSuccess,e.onSqlError)}else console.log("No data id.")},onShowSuccess:function(t,n){var r=n.rows.item(0).title,i=n.rows.item(0).text,s=n.rows.item(0).date,o=n.rows.item(0).photopath,u=n.rows.item(0).videopath,a=n.rows.item(0).audiopath,f=n.rows.item(0).location,l=$("#single-note-page");console.log("Show success!");if(r){r.length>18&&(r=r.substring(0,18)+"...");$("#note-title").text(r)}i&&$("#note-text").text(i);o&&e.displayMedia(l,"photo",o);u&&e.displayMedia(l,"video",u);a&&e.displayMedia(l,"audio",a);if(f){var c='<span class="ui-icon-grey ui-icon-notext ui-icon-mapmarker"></span>'+f;$("#single-note-page").find(".note-location").html(c)}$("#single-note-page").find(".note-date").text(s)},deleteEntry:function(t){e.db.transaction(e.doDeleteEntry,e.onTxError,e.onTxSuccess)},doDeleteEntry:function(t){var n=e.noteForm.attr("data-id");console.log("Attempting to delete entry with id: "+n);if(n){var r="DELETE FROM Notes WHERE id="+n;t.executeSql(r,[],e.onDeleteSuccess,e.onSqlError)}},onDeleteSuccess:function(t,n){console.log("Note successfully deleted.");alert("Anteckning raderad.");e.changePage("home-page");e.noteForm.attr("data-id","")},capturePhoto:function(){if($(this).hasClass("deactivated"))navigator.notification.alert("Du kan bara bifoga en fil per anteckning.",null,"Hoppsan!");else{console.log("Attempting to capture photo");navigator.device.capture.captureImage(e.onCapturePhotoSuccess,e.onPhotoError,{limit:1})}},onCapturePhotoSuccess:function(t){for(var n=0;n<t.length;n++){var r=t[n].fullPath,i=t[n].name,s=t[n].lastModifiedDate,o="Fotograferingen lyckades!<br /><strong>Sökväg:</strong> "+r+"<br />"+"<strong>Namn:</strong> "+i+"<br />"+"<strong>Senast ändrad:</strong> "+s;e.displayMedia($("#add-note-page"),"photo",r)}},displayMedia:function(e,t,n){var r=e.find(".attach-bar"),i=$("<div></div>"),s;t==="photo"?s='<img src="'+n+'" />':t==="audio"?s='<audio src="'+n+'" controls></audio>':t==="video"?s='<video src="'+n+'" width="320" height="240" controls></video>':s="<p>Something went wrong. Try again.</p>";i.addClass("attached-media").html(s);console.log("Container: "+r.attr("class")+", Page: "+e.attr("id"));if(e.attr("id")==="add-note-page"){r.find(".media-btn").addClass("deactivated");console.log("Added class: "+r.find(".media-btn").attr("class"))}r.prepend(i)},undisplayMedia:function(e){console.log("Clicked delete button");$(".attached-media").remove();$(".media-btn").removeClass("deactivated")},onPhotoError:function(e){if(e.code==3)return;navigator.notification.alert(e.message,null,"Error")},getPhoto:function(){if($(this).hasClass("deactivated"))navigator.notification.alert("Du kan bara bifoga en fil per anteckning.",null,"Hoppsan!");else{console.log("Attempting to get photo from device");var t={quality:50,destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG};navigator.camera.getPicture(e.onGetPhotoSuccess,e.onPhotoError,t)}},onGetPhotoSuccess:function(t){e.displayMedia($("#add-note-page"),"photo",t)},captureAudio:function(){if($(this).hasClass("deactivated"))navigator.notification.alert("Du kan bara bifoga en fil per anteckning.",null,"Hoppsan!");else{console.log("Attempting to capture audio");navigator.device.capture.captureAudio(e.onCaptureAudioSuccess,e.onError,{limit:1})}},onCaptureAudioSuccess:function(t){for(var n=0;n<t.length;n++){var r=t[n].fullPath,i="Inspelningen lyckades!<br /><strong>Sökväg:</strong> "+r+"<br />"+"<strong>Namn:</strong> "+t[n].name+"<br />",s=function(e){var t=e.duration};e.displayMedia($("#add-note-page"),"audio",r)}},playAudio:function(){if(path!=undefined){var t=$("#player");t.find("source").attr("src",path);t.trigger("play");e.output.html("Ljudet spelas upp...")}else navigator.notification.alert("Du har inte spelat in något ljud!",null,"Uh oh!")},captureVideo:function(){if($(this).hasClass("deactivated"))navigator.notification.alert("Du kan bara bifoga en fil per anteckning. Ta bort den bifogade filen för att lägga till en ny.",null,"Hoppsan!");else{console.log("Attempting to capture video");navigator.device.capture.captureVideo(e.onVideoSuccess,e.onError,{limit:1})}},onVideoSuccess:function(t){for(var n=0;n<t.length;n++){var r=t[n].fullPath,i=t[n].name,s=t[n].lastModifiedDate,o="Filmningen lyckades!<br /><strong>Sökväg:</strong> "+r+"<br />"+"<strong>Namn:</strong> "+i+"<br />"+"<strong>Senast ändrad:</strong> "+s;e.displayMedia($("#add-note-page"),"video",r)}},playVideo:function(){if(path!=undefined){var t=$("#player");t.attr("src",path);t.trigger("play");e.output.html("Filmen spelas upp...")}else navigator.notification.alert("Du har inte spelat in någon film!",null,"Uh oh!")},onError:function(e){navigator.notification.alert(e.message,null,"Error")}};e.init()});